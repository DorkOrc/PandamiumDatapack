# arguments: item

execute unless data storage pandamium.db.mail:io selected run return fail

execute in pandamium:staff_world run item replace block 5 0 0 contents with air
$execute in pandamium:staff_world run data modify block 5 0 0 item set value $(item)
execute in pandamium:staff_world if items block 5 0 0 contents *[custom_data~{pandamium:{transient_equippable:{}}}] run function pandamium:detect/obtain_transient_equippable_item/apply_fix

data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item" set value {}
execute in pandamium:staff_world run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item set from block 5 0 0 item
execute unless data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.id run return fail

# store item
data modify storage pandamium.db.mail:io selected.entry.data.items append value {}
execute store result storage pandamium.db.mail:io selected.entry.data.items[-1].stored_item_id int 1 store result storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".stored_item_id int 1 run function pandamium:utils/database/stored_items/load_new
execute in pandamium:staff_world run function pandamium:utils/database/stored_items/modify/set_item/from_block {x:5,y:0,z:0,slot:"container.0"}
function pandamium:utils/database/stored_items/save

# filter item to remove large, unnecessary, or private data
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".reduced_item set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".reduced_item.components

data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item set value {count:1,components:{}}
execute in pandamium:staff_world run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item merge from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item
execute store result score <count> variable run data get storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.count

data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:written_book_content".pages[]
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:writable_book_content".pages[]

execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:charged_projectiles"[].components
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:use_remainder"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bees"[0] run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bees"[] set value {min_ticks_in_hive:0,ticks_in_hive:0}
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:lodestone_tracker".target

data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:container"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:bundle_contents"[].components
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:charged_projectiles"[].components
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:use_remainder"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:writable_book_content"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:written_book_content"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:fireworks"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:block_entity_data"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:bucket_entity_data"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:entity_data"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:custom_data"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:bees"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:lodestone_tracker".target
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:custom_name"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:item_name"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:bundle_contents"[].components."minecraft:lore"

data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[].item.components
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:written_book_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:written_book_contents"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:written_book_contents".pages[]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:profile".name set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:profile".name
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:potion_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:potion_contents"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:base_color" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:base_color"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:item_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:item_name"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:custom_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:custom_name"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:lodestone_tracker" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[0].item.components."minecraft:lodestone_tracker" set value {}
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:written_book_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[0].item.components."minecraft:written_book_contents"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:written_book_contents".pages[]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:profile".name set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:profile".name
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:potion_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:potion_contents"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:base_color" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:base_color"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:item_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:item_name"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:custom_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:custom_name"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[1].item.components."minecraft:lodestone_tracker" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[1].item.components."minecraft:lodestone_tracker" set value {}
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:written_book_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:written_book_contents"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:written_book_contents".pages[]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:profile".name set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:profile".name
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:potion_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:potion_contents"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:base_color" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:base_color"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:item_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:item_name"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:custom_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:custom_name"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[2].item.components."minecraft:lodestone_tracker" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[2].item.components."minecraft:lodestone_tracker" set value {}
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:written_book_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:written_book_contents"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:written_book_contents".pages[]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:profile".name set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:profile".name
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:potion_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:potion_contents"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:base_color" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:base_color"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:item_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:item_name"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:custom_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:custom_name"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[3].item.components."minecraft:lodestone_tracker" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[3].item.components."minecraft:lodestone_tracker" set value {}
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:written_book_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:written_book_contents"
data remove storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:written_book_contents".pages[]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:profile".name set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:profile".name
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:profile" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:profile".properties set value [{name:"textures",value:"e30="}]
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:potion_contents" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:potion_contents"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:base_color" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:base_color"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:item_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:item_name"
data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:custom_name" set from storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:custom_name"
execute if data storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".item.components."minecraft:container"[4].item.components."minecraft:lodestone_tracker" run data modify storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item".filtered_item.components."minecraft:container"[4].item.components."minecraft:lodestone_tracker" set value {}

execute in pandamium:staff_world run data modify block 3 0 0 front_text.messages[0] set value '{"color":"red","text":"Item"}'
execute in pandamium:staff_world run data modify block 3 0 0 front_text.messages[1] set value '{"color":"red","text":"Item"}'
execute in pandamium:staff_world if block 3 0 0 oak_sign positioned 0. 0. 0. summon item run function pandamium:impl/database/mail/modify/attach_item/as_item with storage pandamium:local functions."pandamium:utils/database/mail/modify/attach_item"
execute in pandamium:staff_world run data modify storage pandamium.db.mail:io selected.entry.data.items[-1].name set from block 3 0 0 front_text.messages[0]
execute in pandamium:staff_world run data modify storage pandamium.db.mail:io selected.entry.data.items[-1].fallback_name set from block 3 0 0 front_text.messages[1]

return 1

# validate input:
$execute if predicate {condition:"entity_properties",entity:"this",predicate:{equipment:{mainhand:{components:{container:[{slot:0,item:$(item)}]}}}}}
